(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))n(t);new MutationObserver(t=>{for(const s of t)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function c(t){const s={};return t.integrity&&(s.integrity=t.integrity),t.referrerPolicy&&(s.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?s.credentials="include":t.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(t){if(t.ep)return;t.ep=!0;const s=c(t);fetch(t.href,s)}})();const L=document.querySelector(".session-template"),q=document.querySelectorAll(".popup__close"),b=document.querySelector(".sessions__add"),m=document.querySelector(".popup_add-session");document.querySelector(".popup_confirm");const k=document.querySelector(".popup_edit-session"),T=document.querySelector(".popup_buy-tickets"),I=document.querySelectorAll(".popup"),$=document.querySelectorAll(".popup__seat"),C=document.querySelector(".sessions"),D=document.querySelector(".sessions__list"),y=document.querySelector(".error__no-sessions");document.querySelector("#delete-session-btn");const g=document.querySelector(".popup__form_add-session"),S=document.querySelector("#chosenSeats"),w=[],l=[],O=o=>{const[e,c]=o.split(":");return`${e}:${c}`},A=o=>{const e=new Date(o),c=e.toLocaleString("default",{month:"long"}),n=e.getDate();return`${c} ${n}`};D.innerHTML="";fetch("/sessions").then(o=>{if(!o.ok)throw new Error("Ошибка получения списка сеансов");return o.json()}).then(o=>{o.forEach(e=>{const c={title:e.f_title+". "+e.f_type,hall:e.h_name,date:A(e.s_date)+" "+O(e.s_time),image:e.f_images};l.push(c),console.log(l.length),l.length===0?y.classList.add("error_visible"):(y.classList.contains("error_visible")&&y.classList.remove("error_visible"),l.forEach((n,t)=>{const s=L.content.cloneNode(!0).children[0];s.querySelector(".session__title").textContent=n.title,s.querySelector(".session__hall").textContent=n.hall,s.querySelector(".session__date").textContent=n.date,s.querySelector(".session__image").src=n.image,s.querySelector(".session__image").alt=n.title,C.append(s);const r=s.querySelector(".session__edit"),a=s.querySelector(".session__delete"),d=s.querySelector(".session__button");a.addEventListener("click",async()=>{l.splice(t,1),s.remove();try{if(!(await fetch(`/sessions/${e.s_id}`,{method:"DELETE"})).ok)throw new Error("Ошибка удаления сеанса");alert("Сеанс успешно удален")}catch(i){console.error("Ошибка при удалении сеанса:",i),alert("Произошла ошибка при удалении сеанса")}}),r.addEventListener("click",()=>{k.classList.add("popup_opened")}),d.addEventListener("click",async()=>{T.classList.add("popup_opened");try{const i=await fetch(`/tickets/${e.s_id}`,{method:"GET"});if(!i.ok)throw new Error("Ошибка удаления сеанса");const p=await i.json();p.forEach(f=>{const{t_row:E,t_place:h}=f,u=`${E}-${h}`,_=document.getElementById(u);_?_.classList.add("popup__seat_bought"):console.warn(`Элемент с id "${u}" не найден`)}),console.log(p)}catch(i){console.error("Ошибка при удалении сеанса:",i),alert("Произошла ошибка при удалении сеанса")}}),S.addEventListener("submit",async i=>{i.preventDefault();try{const p=new FormData(S),f=Array.from(document.querySelectorAll(".popup__seat_chosen")).map(h=>{const[u,_]=h.id.split("-");return{t_row:u,t_place:_,t_session:e.s_id}});if(!(await fetch(`/tickets/${e.s_id}`,{method:"POST",body:JSON.stringify(f),headers:{"Content-Type":"application/json"}})).ok)throw new Error("Ошибка при добавлении билетов");alert("Билеты успешно добавлены"),location.reload()}catch(p){console.error("Ошибка при добавлении билетов:",p),alert("Произошла ошибка при добавлении билетов")}})}))})}).catch(o=>{console.error("Ошибка при загрузке сеансов:",o)});b.addEventListener("click",async()=>{m.classList.add("popup_opened");try{const o=await fetch("/films");if(!o.ok)throw new Error("Ошибка получения списка фильмов");const e=await o.json(),c=m.querySelector(".popup__form .popup__select");e.forEach(n=>{const t=document.createElement("option");t.id=n.f_id,t.textContent=n.f_title,t.name="filmId",c.appendChild(t)})}catch(o){console.error("Ошибка при загрузке фильмов:",o)}try{const o=await fetch("/halls");if(!o.ok)throw new Error("Ошибка получения списка залов");const e=await o.json(),c=m.querySelector(".popup__select-hall");console.log(c),e.forEach(n=>{const t=document.createElement("option");t.id=n.h_id,t.textContent=n.h_name,t.name="hallId",c.appendChild(t)})}catch(o){console.error("Ошибка при загрузке залов:",o)}console.log(l)});g.addEventListener("submit",async o=>{o.preventDefault();const e=new FormData(g),c=document.querySelector(".popup__select"),n=document.querySelector(".popup__select-hall"),t=c.options[c.selectedIndex].id,s=n.options[n.selectedIndex].id,r=e.get("date"),a=e.get("time");try{if(!(await fetch("/sessions",{method:"POST",body:JSON.stringify({date:r,time:a,hallId:s,filmId:t}),headers:{"Content-Type":"application/json"}})).ok)throw new Error("Ошибка добавления сеанса");alert("Сеанс успешно добавлен"),location.reload()}catch(d){console.error("Ошибка при добавлении сеанса:",d),alert("Произошла ошибка при добавлении сеанса")}});q.forEach(o=>{o.addEventListener("click",()=>{I.forEach(e=>{e.classList.contains("popup_opened")&&e.classList.remove("popup_opened")})})});$.forEach(o=>{o.addEventListener("click",e=>{if(!e.target.classList.contains("popup__seat_chosen")&&!e.target.classList.contains("popup__seat_bought")){e.target.classList.add("popup__seat_chosen");const c=document.querySelector(".popup__ticket-info");c.classList.add("popup__ticket-info_visible");const n=o.id.match(/\d+/g),t=document.createElement("li"),s=parseInt(n[0]),r=parseInt(n[1]);t.textContent=`Ряд - ${s}, место - ${r}`,c.append(t);const a={row:s,place:r};w.push(a),console.log(w)}else e.target.classList.contains("popup__seat_chosen")&&e.target.classList.remove("popup__seat_chosen");console.log(o.id)})});
